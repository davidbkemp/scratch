(function(e){var t=function(t,n,r){var i,s=function(){t=t||e.Q,n=n||e.d3,r=r||e.d3MeasureText,i=n.svg.transform().translate(function(e){return[e.x,e.y]}).scale(function(e){return e.amplitude.magnitude()}).rotate(function(e){return-180*e.amplitude.phase()/Math.PI})},o=function(e){return s(),u(n.select(e))},u=function(e){function o(e,t){var n=t.length,r=t.lineClass,i=t.headClass;e.append("line").attr("class",r).attr("x1",0).attr("y1",0).attr("x2",n).attr("y2",0);var s=n/4,o=n-s,u=-s/2,a=o,f=u+s,l=n,c=0;e.append("polygon").attr("class",i).attr("points",""+o+","+u+" "+a+","+f+" "+l+","+c)}r.d3=r.d3||n;var s=r("M"),a=function(e,t,n){var r=e.enter().append("g").attr("class","animatedQubitsAmplitudeDisc").attr("transform",i);r.append("circle").attr("class","animatedQubitsAmplitudeCircle").attr("cx",0).attr("cy",0).attr("r",n.maxRadius),o(r,{length:n.maxRadius,lineClass:"animatedQubitsPhaseArrow",headClass:"animatedQubitsPhaseArrowEnd"})},f=function(e,n,r,s){var o=[],u=[];return e.transition().duration(s.duration==null?1e3:s.duration).attr("transform",i).each(function(){var e=t.defer();o.push(e),u.push(e.promise)}).each("end",function(){o.pop().resolve()}),t.all(u)};return{getTextHeight:function(){return s.height},getTextWidth:function(){return s.width*1.5},setHeight:function(t){e.attr("height",t)},setWidth:function(t){e.attr("width",t)},addText:function(t){var n=t["class"],r=t.x||0,i=t.y||0,s=t.text;e.append("text").attr("x",r).attr("y",i).attr("class",n).text(s)},addTextWithSubscript:function(t,n,r,i){var o=e.append("g").append("text").attr("x",r);o.append("tspan").text(t).attr("y",i),o.append("tspan").text(n).attr("class","animatedTextSubscript").attr("y",i+s.height/2)},createGroup:function(t){var r=t["class"],i=t.x||0,s=t.y||0,o=n.svg.transform().translate([i,s]),a=e.append("g").attr("class",r).attr("transform",o);return u(a)},renderAmplitudeDiscs:function(t,n,r){r=r||{};var i=e.selectAll(".animatedQubitsAmplitudeDisc").data(t,function(e){return e.key}),s=f(i,t,n,r);return a(i,t,n),i.exit().remove(),s}}};return o};typeof define!="undefined"&&define.amd?define("qubitsGraphics",["q","d3","d3MeasureText"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("q"),require("d3"),require("d3-measure-text")):(e.animatedQubitsInternal=e.animatedQubitsInternal||{},e.animatedQubitsInternal.graphicsFactory=t())})(this),function(e){var t=function(t,n){var r=function(){t=t||e._,n=n||e.jsqubits},i=function(e){r();var i=e.maxRadius,s=n.complex(1e-4),o=function(e){return i*(e*Math.SQRT2+1)},u=function(e,r){var i=t.clone(e);return i.key=e.key+"-"+r,r>1&&(i.amplitude=n.ZERO),i},a=function(e,n){var r=t.clone(n);return r.amplitude=e.amplitude,r},f=function(n,r,s){var u=t.clone(n),a=r.asNumber();u.amplitude=n.amplitude.multiply(r.amplitude),u.bitString=r.asBitString(),u.numericIndex=a;var f=s[a];if(!f)f=s[a]=[],u.x=i,u.y=o(a);else{var l=t.last(f),c=l.amplitude;u.x=l.x+c.real()*e.maxRadius,u.y=l.y-c.imaginary()*e.maxRadius}return f.push(u),u},l=function(e){return Object.keys(e).map(function(n){return e[n].map(function(t){return t.key})})},c=function(r,i){var o=function(e){return e.reduce(function(t,n){return t.add(r.phase2b[n].amplitude)},n.ZERO)},u=function(e){var n=o(e),i=t.clone(r.phase2b[e[0]]);return i.amplitude=n.magnitude()>1e-4?n:i.amplitude.multiply(s),r.phase3.push(i),i},a=function(n,i){var o=n.amplitude,u=n.x+o.real()*e.maxRadius,a=n.y-o.imaginary()*e.maxRadius;for(var f=1;f<i.length;f++){var l=i[f],c=t.clone(r.phase2b[l]);c.amplitude=c.amplitude.multiply(s),c.x=u,c.y=a,r.phase3.push(c)}};i.forEach(function(e){var t=u(e);a(t,e)})},h=function(e,t,r,i){return e.forEach(function(e){var s=t(n(e.bitString)),o=[];r.stateComponentIndexesGroupedBySource.push(o);var l=1;s.each(function(t){var n=u(e,l++),s=a(e,n),c=n.key;o.push(r.phase1.length),r.phase1.push(n),r.phase2a[c]=s,r.phase2b[c]=f(s,t,i)})}),r},p=function(e){e.phase4=e.phase3.filter(function(t){return t.amplitude.magnitude()>1e-4})},d=function(e){e.phase5=e.phase4.map(function(n){var r=t.clone(n);return r.x=0,r})};return{yOffSetForState:o,augmentState:function(e){var t=0,n=[];return e.each(function(e){var r={bitString:e.asBitString(),numericIndex:e.asNumber(),amplitude:e.amplitude,key:"k"+ ++t,x:0,y:o(e.asNumber())};n.push(r)}),n.sort(function(e,t){return e.numericIndex-t.numericIndex}),n},createPhases:function(e,t){var n={phase1:[],phase2a:{},phase2b:{},stateComponentIndexesGroupedBySource:[],phase3:[]},r={};return h(e,t,n,r),c(n,l(r)),p(n),d(n),n}}};return i};typeof define!="undefined"&&define.amd?define("qubitAnimationCalculator",["lodash","jsqubits"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("lodash"),require("jsqubits").jsqubits):(e.animatedQubitsInternal=e.animatedQubitsInternal||{},e.animatedQubitsInternal.calculatorFactory=t())}(this),function(e){var t=function(t,n){var r=function(){t=t||e.animatedQubitsInternal.graphicsFactory,n=n||e.animatedQubitsInternal.calculatorFactory},i=function(e){r();var i=t(e.element),s=n(e),o=e.maxRadius,u=e.numBits,a=1<<u,f=i.getTextHeight(),l=i.getTextWidth(),c,h=function(){return s.yOffSetForState(a-1)+o},p=function(){return(1+u)*l+6*o},d=function(e){return("0000000000000000"+e.toString(2)).slice(-u)},v=function(e,t){var n=d(e);for(var r=0;r<u;r++)t.addText({"class":"animatedQubitsStateBitLabel",x:r*l,text:n.charAt(r)})};return{updateDimensions:function(){i.setHeight(h()),i.setWidth(p())},renderBitLabels:function(){var e=2*f/3;for(var t=0;t<u;t++){var n=(u-t-1).toString(),r=t*l;i.addTextWithSubscript("q",n,r,e)}},renderStateLabels:function(){for(var e=0;e<a;e++)v(e,i.createGroup({"class":"animatedQubitsStateLabel",y:s.yOffSetForState(e)+f/3}))},renderState:function(t,n){return c=c||i.createGroup({"class":"animatedQubitsAmplitudeDiscs",x:o+(u+1)*l}),c.renderAmplitudeDiscs(t,e,n)}}};return i};typeof define!="undefined"&&define.amd?define("animatedQubitsRenderer",["qubitsGraphics","qubitAnimationCalculator"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("./qubitsGraphics"),require("./qubitAnimationCalculator")):(e.animatedQubitsInternal=e.animatedQubitsInternal||{},e.animatedQubitsInternal.rendererFactory=t())}(this),function(e){var t=function(t,n,r,i){var s=function(){t=t||e._,n=n||e.Q,r=r||e.animatedQubitsInternal.rendererFactory,i=i||e.animatedQubitsInternal.calculatorFactory};return function(e,o){s();var u,a=e.numBits(),f,l=i(o),c=n.when(),h=function(e){return f.renderState(e,{duration:0})},p=function(e,t){return function(){var r=n.when();return e.stateComponentIndexesGroupedBySource.forEach(function(n){r=r.then(d(e,t,n)).then(v(e,t,n))}),r}},d=function(e,t,n){return function(){return n.forEach(function(n){var r=t[n].key;t[n]=e.phase2a[r]}),f.renderState(t,{duration:0})}},v=function(e,t,n){return function(){return n.forEach(function(n){var r=t[n].key;t[n]=e.phase2b[r]}),f.renderState(t)}},m=function(t){return f.renderState.bind(null,t.phase3)},g=function(t){return f.renderState.bind(null,t.phase4,{duration:0})},y=function(t){return f.renderState.bind(null,t.phase5)},b=function(n,r){var i=l.createPhases(u,n),s=i.phase1.map(t.clone);return e=n(e),u=l.augmentState(e),r&&r.skipInterferenceSteps?h(s).then(y(i)):h(s).then(p(i,s)).then(m(i)).then(g(i)).then(y(i))};return{display:function(t){f=r({element:t,numBits:a,maxRadius:o.maxRadius}),f.updateDimensions(),f.renderBitLabels(),f.renderStateLabels(),u=l.augmentState(e),f.renderState(u)},applyOperation:function(e,t){return c=c.then(function(){return b(e,t)}),c}}}};typeof define!="undefined"&&define.amd?define("animatedQubits",["lodash","q","animatedQubitsRenderer","qubitAnimationCalculator"],t):typeof module!="undefined"&&module.exports?module.exports=t(require("lodash"),require("q"),require("./lib/animatedQubitsRenderer"),require("./lib/qubitAnimationCalculator")):e.animatedQubits=t()}(this);